<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="kr.co.bookhub.mapper.CategoryBooksMapper">

	<!-- 카테고리 -->
	<resultMap type="Category" id="CategoryResultMap">
		<id				column="CATEGORY_NO"			property="no"/>
		<result			column="CATEGORY_NAME"			property="name"/>
	</resultMap>
	
	<!-- 도서 -->
	<resultMap type="Book" id="BookResultMap">
		<id				column="BOOK_NO"				property="no"/>
		<result			column="BOOK_TITLE"				property="title"/>
		<result			column="BOOK_AUTHOR"			property="author"/>
		<result			column="BOOK_PUBLISHER"			property="publisher"/>
		<result			column="BOOK_DESCRIPTION"		property="description"/>
		<result			column="BOOK_PUB_DATE"			property="pubDate"/>
		<result			column="BOOK_REVIEW_COUNT"		property="reviewCount"/>
		<result			column="BOOK_REVIEW_AVG"		property="reviewAvg"/>
		<result			column="BOOK_COVER_IMAGE_PATH"	property="coverImagePath"/>
		<result			column="BOOK_CREATED_DATE"		property="createdDate"/>
		<result			column="BOOK_UPDATED_DATE"		property="updatedDate"/>
		<result			column="BOOK_ISBN"				property="isbn"/>
	</resultMap>

	<!-- 대분류 목록 가져오기
	List<Category> getMainCategory() -->
	<select id="getMainCategory" resultMap="CategoryResultMap">
		SELECT 
			CATEGORY_NO				
			, CATEGORY_NAME			
		FROM
			BOOKHUB_CATEGORIES
		WHERE
			CATEGORY_PARENTS_NO IS NULL OR CATEGORY_PARENTS_NO = ''
		ORDER BY
			CATEGORY_NAME ASC
	</select>
	
	
	<!-- 특정 대분류 정보 가져오기
	 * @param cateNo 대분류 번호
	 * @return 카테고리 정보
	Category getCategory(int cateNo) -->
	<select id="getCategory" resultMap="CategoryResultMap">
		SELECT 
			CATEGORY_NO				
			, CATEGORY_NAME			
		FROM
			BOOKHUB_CATEGORIES
		WHERE
			CATEGORY_NO = #{cateNo}
	</select>
	
	<!-- 대분류 번호를 전달받아 대분류에 속한 하위 분류 목록 가져오기
	List<Category> getSubCategory(int cateNo) -->	
	<select id="getSubCategory" resultMap="CategoryResultMap">
		SELECT 
			CATEGORY_NO				
			, CATEGORY_NAME			
		FROM
			BOOKHUB_CATEGORIES
		WHERE
			CATEGORY_PARENTS_NO IS NOT NULL
		AND 
			CATEGORY_PARENTS_NO = #{cateNo}
		ORDER BY
			CATEGORY_NAME ASC
	</select>
	
	<!-- 조건에 맞는 모든 데이터 개수 가져오기
	 * @param condition.cateNo 대분류 번호
	 * @param condition.subCateNo 대분류에 속한 하위 분류 번호(선택하지 않으면 0)
	 * @return 조회된 모든 데이터 개수
	int getTotalRows(Map<String, Object> condition) -->
	<select id="getTotalRows" parameterType="map">
		SELECT 
			COUNT(*)
		FROM 
			BOOKHUB_BOOKS B, BOOKHUB_CATEGORIES C
		WHERE
			B.CATEGORY_NO = C.CATEGORY_NO
		AND
		<choose>
			<when test="subCateNo != 0">
				C.CATEGORY_NO = #{subCateNo}
			</when>
			<otherwise>
				C.CATEGORY_PARENTS_NO = #{cateNo}
			</otherwise>
		</choose>
	</select>
	
	<!-- 대분류에 속한 하위분류 번호로 도서 목록 가져오기
	 * @param condition.cateNo 대분류 번호
	 * @param condition.subCateNo 대분류에 속한 하위 분류 번호(선택하지 않으면 0)
	 * @param condition.offset 요청페이지 offset 값 
	 * @param condition.rows 요청페이지의 데이서 개수 
	 * @param condition.sort 정렬조건
	List<Book> getBooksByCategory(Map<String, Object> condition) -->
	<select id="getBooksByCategory" parameterType="map" resultMap="BookResultMap">
		SELECT
			B.BOOK_NO
			, B.BOOK_TITLE
			, B.BOOK_AUTHOR
			, B.BOOK_PUBLISHER
			, B.BOOK_DESCRIPTION
			, B.BOOK_PUB_DATE
			, B.BOOK_REVIEW_COUNT
			, B.BOOK_REVIEW_AVG
			, B.BOOK_COVER_IMAGE_PATH
			, B.BOOK_CREATED_DATE
			, B.BOOK_UPDATED_DATE
			, B.BOOK_ISBN
		FROM
			BOOKHUB_BOOKS B, BOOKHUB_CATEGORIES C
		WHERE
			B.CATEGORY_NO = C.CATEGORY_NO
		AND
		<choose>
			<when test="subCateNo != 0">
				C.CATEGORY_NO = #{subCateNo}
			</when>
			<otherwise>
				C.CATEGORY_PARENTS_NO = #{cateNo}
			</otherwise>
		</choose>
		<choose>
			<when test="sort == 'newest'">
				ORDER BY B.BOOK_PUB_DATE DESC
			</when>
			<when test="sort == 'title'">
				ORDER BY B.BOOK_TITLE ASC
			</when>
			<when test="sort == 'rating'">
				ORDER BY B.BOOK_REVIEW_AVG DESC
			</when>
		</choose>
		OFFSET #{offset} ROWS
		FETCH NEXT #{rows} ROWS ONLY
	</select>
	
</mapper>